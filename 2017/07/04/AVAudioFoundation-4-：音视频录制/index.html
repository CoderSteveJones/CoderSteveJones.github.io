<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.3 -->

    <!-- Title -->
    
    <title>
        
            AVAudioFoundation(4)：音视频录制 | 
        
        Aben
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Aben">
    <meta name="description" content="null">
    <meta name="keywords" content="null">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/icon.png">
    <link rel="icon" sizes="192x192" href="/img/icon.png">
    <link rel="apple-touch-icon" href="/img/icon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Aben">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="AVAudioFoundation(4)：音视频录制 | Aben">
    <meta property="og:description" content="null">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(/img/bg.png);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用-Capture-Session-来协调数据流"><span class="post-toc-number">1.</span> <span class="post-toc-text">使用 Capture Session 来协调数据流</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置-Session"><span class="post-toc-number">1.0.1.</span> <span class="post-toc-text">配置 Session</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#监控-Session-状态"><span class="post-toc-number">1.0.2.</span> <span class="post-toc-text">监控 Session 状态</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用-AVCaptureDevice-来表示输入设备"><span class="post-toc-number">2.</span> <span class="post-toc-text">使用 AVCaptureDevice 来表示输入设备</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设备特性"><span class="post-toc-number">2.0.1.</span> <span class="post-toc-text">设备特性</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#设备录制设置"><span class="post-toc-number">3.</span> <span class="post-toc-text">设备录制设置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#聚焦模式"><span class="post-toc-number">3.0.1.</span> <span class="post-toc-text">聚焦模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#曝光模式"><span class="post-toc-number">3.0.2.</span> <span class="post-toc-text">曝光模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#闪光灯模式"><span class="post-toc-number">3.0.3.</span> <span class="post-toc-text">闪光灯模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手电筒模式"><span class="post-toc-number">3.0.4.</span> <span class="post-toc-text">手电筒模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#视频防抖"><span class="post-toc-number">3.0.5.</span> <span class="post-toc-text">视频防抖</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#白平衡"><span class="post-toc-number">3.0.6.</span> <span class="post-toc-text">白平衡</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设置方向"><span class="post-toc-number">3.0.7.</span> <span class="post-toc-text">设置方向</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置设备"><span class="post-toc-number">3.0.8.</span> <span class="post-toc-text">配置设备</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设备切换"><span class="post-toc-number">3.0.9.</span> <span class="post-toc-text">设备切换</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用-Capture-Inputs-来给一个-Session-添加设备"><span class="post-toc-number">4.</span> <span class="post-toc-text">使用 Capture Inputs 来给一个 Session 添加设备</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用-Capture-Outputs-来从一个-Session-获取输出"><span class="post-toc-number">5.</span> <span class="post-toc-text">使用 Capture Outputs 来从一个 Session 获取输出</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#保存电影文件"><span class="post-toc-number">6.</span> <span class="post-toc-text">保存电影文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#开始录制"><span class="post-toc-number">6.0.1.</span> <span class="post-toc-text">开始录制</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#确保文件写入成功"><span class="post-toc-number">6.0.2.</span> <span class="post-toc-text">确保文件写入成功</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#给文件添加-Metadata"><span class="post-toc-number">6.0.3.</span> <span class="post-toc-text">给文件添加 Metadata</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#处理视频帧"><span class="post-toc-number">6.0.4.</span> <span class="post-toc-text">处理视频帧</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#处理视频的性能问题"><span class="post-toc-number">6.0.5.</span> <span class="post-toc-text">处理视频的性能问题</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#截取静态图片"><span class="post-toc-number">7.</span> <span class="post-toc-text">截取静态图片</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#像素和编码类型"><span class="post-toc-number">7.0.1.</span> <span class="post-toc-text">像素和编码类型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#捕获图像"><span class="post-toc-number">7.0.2.</span> <span class="post-toc-text">捕获图像</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#预览"><span class="post-toc-number">8.</span> <span class="post-toc-text">预览</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#视频预览"><span class="post-toc-number">8.0.1.</span> <span class="post-toc-text">视频预览</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#视频重力模式"><span class="post-toc-number">8.0.2.</span> <span class="post-toc-text">视频重力模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用预览时的点击聚焦"><span class="post-toc-number">8.0.3.</span> <span class="post-toc-text">使用预览时的点击聚焦</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#显示音频等级"><span class="post-toc-number">9.</span> <span class="post-toc-text">显示音频等级</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一个完整示例"><span class="post-toc-number">10.</span> <span class="post-toc-text">一个完整示例</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#高帧率视频获取"><span class="post-toc-number">10.0.1.</span> <span class="post-toc-text">高帧率视频获取</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#播放"><span class="post-toc-number">10.0.2.</span> <span class="post-toc-text">播放</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#编辑"><span class="post-toc-number">10.0.3.</span> <span class="post-toc-text">编辑</span></a></li></ol></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                AVAudioFoundation(4)：音视频录制
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Aben</strong>
        <span>7月 04, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=AVAudioFoundation(4)：音视频录制&url=http://yoursite.com//2017/07/04/AVAudioFoundation-4-：音视频录制/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=AVAudioFoundation(4)：音视频录制&url=http://yoursite.com//2017/07/04/AVAudioFoundation-4-：音视频录制/index.html&via=Aben" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2017/07/04/AVAudioFoundation-4-：音视频录制/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2017/07/04/AVAudioFoundation-4-：音视频录制/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>本文转自：<a href="http://www.samirchen.com/ios-av-asset" target="_blank" rel="external">AVAudioFoundation(4)：音视频录制 | www.samirchen.com</a><br>本文主要内容来自 <a href="https://developer.apple.com/library/content/documentation/AudioVideo/Conceptual/AVFoundationPG/Articles/00_Introduction.html" target="_blank" rel="external">AVFoundation Programming Guide</a>。</p>
<p>采集设备的音视频时，我们需要组装各路数据，这时可以使用 AVCaptureSession 对象来协调。</p>
<ul>
<li>一个 <code>AVCaptureDevice</code> 对象表示输入设备，比如摄像头或者麦克风。</li>
<li>一个 <code>AVCaptureInput</code> 具体子类的实例可以用来配置输出设备的端口。</li>
<li>一个 <code>AVCaptureOutput</code> 具体子类的实例可以用来将音视频数据输出到一个视频文件或静态图片。</li>
<li>一个 <code>AVCaptureSession</code> 实例用来协调输入输出的数据流。<br>在录制视频时，为了让用户看到预览效果，我们可以使用 <code>AVCaptureVideoPreviewLayer</code>。</li>
</ul>
<p>下图展示了通过一个 <code>capture session</code> 实例来协调多路输入输出数据：</p>
<p><img src="http://oqepgj2jp.bkt.clouddn.com/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BD%95%E5%88%B61.png" alt="图一"></p>
<p>对于大多数应用场景，这些细节已经足够我们用了。但是对于有些操作，比如当我们想要监测一个音频通道的强度，我们需要了解不同的输入设备的端口对应的对象，以及这些端口和输出是如何连接起来的。</p>
<p>在音视频录制时，输入和输出之间的连接是用 <code>AVCaptureConnection</code> 来表示的。输入方(<code>AVCaptureInput</code>)包含一个或多个输入端口(<code>AVCaptureInputPort</code>)，输出端(<code>AVCaptureOutput</code>)可以从一个或多个数据源接收数据，比如一个 <code>AVCaptureMovieFileOutput</code> 就可以同时接收视频和音频数据。</p>
<p>当你往一次录制 <code>session</code> 中添加一个输入或输出时，这个 <code>session</code> 会生成所有兼容的输入和输出端口间的连接，由 <code>AVCaptureConnection</code> 对象表示。</p>
<p><img src="http://oqepgj2jp.bkt.clouddn.com/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BD%95%E5%88%B62.png" alt="图二"></p>
<p>You can use a capture connection to enable or disable the flow of data from a given input or to a given output. You can also use a connection to monitor the average and peak power levels in an audio channel.</p>
<p>我们可以用 <code>connetion</code> 对象来控制输入输出端之间的数据流的断开或连接，我们还能用它来监控 <code>audio</code> 通道的平均值和峰值。</p>
<h2 id="使用-Capture-Session-来协调数据流"><a href="#使用-Capture-Session-来协调数据流" class="headerlink" title="使用 Capture Session 来协调数据流"></a>使用 Capture Session 来协调数据流</h2><p><code>AVCaptureSession</code> 是我们用来管理数据捕获的核心协调者，我们用它来协调音视频输入和输出端的数据流。我们可以将我们需要的捕获设备添加到 <code>session</code> 中，然后用 <code>startRunning</code> 接口启动数据流，用 <code>stopRunning</code> 停止数据流。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVCaptureSession alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Add inputs and outputs.</span>
<span class="token punctuation">[</span>session startRunning<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="配置-Session"><a href="#配置-Session" class="headerlink" title="配置 Session"></a>配置 Session</h4><p>我们可以给 <code>session</code> 设置我们需要的图像质量和分辨率。以下是其中的几个配置选项：</p>
<ul>
<li>AVCaptureSessionPresetHigh，高分辨率，具体值取决于设备能提供的最高分辨率。</li>
<li>AVCaptureSessionPresetMedium，中等分辨率，具体值取决于设备。</li>
<li>AVCaptureSessionPresetLow，低分辨率，具体指取决于设备。</li>
<li>AVCaptureSessionPreset640x480，分辨率为 640x480，常称为 480P。</li>
<li>AVCaptureSessionPreset1280x720，分辨率为 1280x720，常称为 720P。</li>
<li>AVCaptureSessionPresetPhoto，全尺寸相片的分辨率，这个选项不支持输出视频。<br>如果要使用某种分辨率选项，我们需要先测试一下设备是否支持：</li>
</ul>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>session canSetSessionPreset<span class="token punctuation">:</span>AVCaptureSessionPreset1280x720<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    session<span class="token punctuation">.</span>sessionPreset <span class="token operator">=</span> AVCaptureSessionPreset1280x720<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle the failure.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果想对 <code>session</code> 的配置参数做更细粒度的控制，或者想修改已经在运行状态的 <code>session</code> 的配置参数，我们需要在 <code>beginConfiguration</code> 和 <code>commitConfiguration</code> 方法直接做修改。这两个方法的配合，可以使得我们队设备的修改是以一个 <code>group</code> 的方式提交，从而尽量避免视觉或者状态上的不一致性。在调用了 <code>beginConfiguration</code> 之后，我们可以增加或删除输出端，修改 <code>sessionPreset</code> 值，单独配置视频捕获的输入或输出参数。知道我们调用了 <code>commitConfiguration</code>，这些修改采用被提交并一起应用。</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>session beginConfiguration<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Remove an existing capture device.</span>
<span class="token comment" spellcheck="true">// Add a new capture device.</span>
<span class="token comment" spellcheck="true">// Reset the preset.</span>
<span class="token punctuation">[</span>session commitConfiguration<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="监控-Session-状态"><a href="#监控-Session-状态" class="headerlink" title="监控 Session 状态"></a>监控 Session 状态</h4><p>录制过程中 <code>session</code> 会发出通知来告知其对应的状态，比如 <code>session</code> 开始、结束、被打断。我们可以从 <code>AVCaptureSessionRuntimeErrorNotification</code> 来接收 <code>session</code> 运行时的错误。我们也可以差选 <code>session</code> 的运行时属性来获取其状态是在运行中还是被打断。此外，这些属性都是支持 <code>KVO</code> 监测的，并且通知会被发送到主线程。</p>
<h2 id="使用-AVCaptureDevice-来表示输入设备"><a href="#使用-AVCaptureDevice-来表示输入设备" class="headerlink" title="使用 AVCaptureDevice 来表示输入设备"></a>使用 AVCaptureDevice 来表示输入设备</h2><p><code>AVCaptureDevice</code> 是由我们现实中物理的提供输入数据（比如音频或视频输入）的设备抽象而来，每个 <code>AVCaptureDevice</code> 对象都对应着一个输入设备，比如我们常见的前置摄像头、后置摄像头、麦克风。它们采集的数据将会输出给 <code>AVCaptureSession</code> 实例。</p>
<p>我们可以使用 <code>AVCaptureDevice</code> 的 <code>devices</code> 和 <code>devicesWithMediaType:</code> 类方法来检查哪些是当前可用的设备。如果需要，我们还可以获取设备支持哪些功能。当前可用的设备列表是会动态变化的，有些设备会因为被别的应用使用而变得不可用，有的设备也有可能突然就可用了，所以我们需要注册 <code>AVCaptureDeviceWasConnectedNotification</code> 和 <code>AVCaptureDeviceWasDisconnectedNotification</code> 通知来感知当前可用设备的变化情况。</p>
<p>我们可以使用 <code>capture input</code> 来想向一个 <code>AVCaptureSession</code> 中添加输入设备。</p>
<h4 id="设备特性"><a href="#设备特性" class="headerlink" title="设备特性"></a>设备特性</h4><p>我们可以查询采集设备的不同特性。比如，我们可以使用 hasMediaType: 接口来判断采集设备是否支持某种媒体类型，也可以使用 supportsAVCaptureSessionPreset: 接口来判断采集设备是否支持预设的 session preset。我们还能获取设备的位置、本地化命名等信息以便于展示给用户。</p>
<p><img src="http://oqepgj2jp.bkt.clouddn.com/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BD%95%E5%88%B63.png" alt="图三"></p>
<p>下面的示例代码展示了如何遍历设备，并打印设备名：</p>
<pre class=" language-objectivec"><code class="language-objectivec">NSArray <span class="token operator">*</span>devices <span class="token operator">=</span> <span class="token punctuation">[</span>AVCaptureDevice devices<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>AVCaptureDevice <span class="token operator">*</span>device <span class="token keyword">in</span> devices<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"Device name: %@"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>device localizedName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>device hasMediaType<span class="token punctuation">:</span>AVMediaTypeVideo<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>device position<span class="token punctuation">]</span> <span class="token operator">==</span> AVCaptureDevicePositionBack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"Device position : back"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"Device position : front"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>此外，你还能查出设备的 model ID 和 unique ID。</p>
<h2 id="设备录制设置"><a href="#设备录制设置" class="headerlink" title="设备录制设置"></a>设备录制设置</h2><p>不同的设备有不同的能力，比如有些设备支持不同的对焦或刷新模式。下面的代码展示了如何找到一个支持手电筒以及预设的 <code>preset</code> 的设备。</p>
<pre class=" language-objectivec"><code class="language-objectivec">NSArray <span class="token operator">*</span>devices <span class="token operator">=</span> <span class="token punctuation">[</span>AVCaptureDevice devicesWithMediaType<span class="token punctuation">:</span>AVMediaTypeVideo<span class="token punctuation">]</span><span class="token punctuation">;</span>
NSMutableArray <span class="token operator">*</span>torchDevices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSMutableArray alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>AVCaptureDevice <span class="token operator">*</span>device <span class="token keyword">in</span> devices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>device hasTorch<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
         <span class="token punctuation">[</span>device supportsAVCaptureSessionPreset<span class="token punctuation">:</span>AVCaptureSessionPreset640x480<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>torchDevices addObject<span class="token punctuation">:</span>device<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果你找到多个设备，你可以向用户展示设备的 <code>localizedName</code> 来让用户选择他们需要的设备。在使用对应的设备时，我们可以设置设备的各种工作模式，但是有一点需要注意的是在设置前需要对设备加锁。</p>
<h4 id="聚焦模式"><a href="#聚焦模式" class="headerlink" title="聚焦模式"></a>聚焦模式</h4><p>目前支持的聚焦模式有以下几种：</p>
<ul>
<li>AVCaptureFocusModeLocked：聚焦点固定。通常以拍摄场景的中点作为焦点。</li>
<li>AVCaptureFocusModeAutoFocus：自动聚焦。这种模式可以让用户选择一件事物来进行对焦，即使对于的位置不是拍摄场景的中点。</li>
<li>AVCaptureFocusModeContinuousAutoFocus：相机将持续自动对焦。<br>我们可以使用 isFocusModeSupported: 接口来检查设备是否支持相应的聚焦模式，然后设置对应的 focusMode 属性。</li>
</ul>
<p>我们还能用 <code>focusPointOfInterestSupported</code> 来检查设备是否支持指定焦点，如果支持，我们就可以设置对应的 <code>focusPointOfInterest</code>属性。其中 {0, 0} 表示左上角，{1, 1} 表示右下角。</p>
<p>我们可以访问 <code>adjustingFocus</code> 属性来获知相机是否正在对焦，这个属性是支持 KVO 的，所以我们可以监测它来获知对焦状态的变化。</p>
<p>如果你修改过了相机的对焦模式相关的设置，你可以用下面的代码将其恢复到默认状态：</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>currentDevice isFocusModeSupported<span class="token punctuation">:</span>AVCaptureFocusModeContinuousAutoFocus<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CGPoint autofocusPoint <span class="token operator">=</span> <span class="token function">CGPointMake</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>currentDevice setFocusPointOfInterest<span class="token punctuation">:</span>autofocusPoint<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>currentDevice setFocusMode<span class="token punctuation">:</span>AVCaptureFocusModeContinuousAutoFocus<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="曝光模式"><a href="#曝光模式" class="headerlink" title="曝光模式"></a>曝光模式</h4><p>目前支持的曝光模式有以下几种：</p>
<ul>
<li>AVCaptureExposureModeLocked，曝光等级锁定。</li>
<li>AVCaptureExposureModeAutoExpose，相机自动根据情况调整一次曝光等级，然后将曝光模式切换到 AVCaptureExposureModeLocked。</li>
<li>AVCaptureExposureModeContinuousAutoExposure，相机随时根据情况调整曝光等级。</li>
<li>AVCaptureExposureModeCustom，用户自定义曝光等级。<br>我们可以通过 isExposureModeSupported: 来检查设备是否支持对应的模式，然后设置对应的 exposureMode 属性。</li>
</ul>
<p>我们还能用 <code>exposurePointOfInterestSupported</code> 来检查设备是否支持指定曝光点，如果支持，我们就可以设置对应的 <code>exposurePointOfInterest</code> 属性。其中 {0, 0} 表示左上角，{1, 1} 表示右下角。</p>
<p>我们可以访问 <code>adjustingExposure</code> 属性来获知相机是否正在改变曝光设置，这个属性是支持 KVO 的，所以我们可以监测它来获知曝光状态的变化。</p>
<p>如果你修改过了相机的曝光模式相关的设置，你可以用下面的代码将其恢复到默认状态：</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>currentDevice isExposureModeSupported<span class="token punctuation">:</span>AVCaptureExposureModeContinuousAutoExposure<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CGPoint exposurePoint <span class="token operator">=</span> <span class="token function">CGPointMake</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>currentDevice setExposurePointOfInterest<span class="token punctuation">:</span>exposurePoint<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>currentDevice setExposureMode<span class="token punctuation">:</span>AVCaptureExposureModeContinuousAutoExposure<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="闪光灯模式"><a href="#闪光灯模式" class="headerlink" title="闪光灯模式"></a>闪光灯模式</h4><p>目前支持的闪光灯模式有如下几种：</p>
<ul>
<li>AVCaptureFlashModeOff，不会闪光。</li>
<li>AVCaptureFlashModeOn，会闪光。</li>
<li>AVCaptureFlashModeAuto，根据具体情况决定是否闪光。<br>我们可以通过 <code>hasFlash</code> 检查设备是否有闪光灯，可以通过 <code>isFlashModeSupported:</code> 检查设备是否支持对应的模式，通过 <code>flashMode</code> 设置对应的模式。</li>
</ul>
<h4 id="手电筒模式"><a href="#手电筒模式" class="headerlink" title="手电筒模式"></a>手电筒模式</h4><p>在手电筒模式下，闪光灯会以低耗电量模式持续打开来为图像录制来照明。目前支持的模式有以下几种：</p>
<ul>
<li>AVCaptureTorchModeOff，关闭。</li>
<li>AVCaptureTorchModeOn，开启。</li>
<li>AVCaptureTorchModeAuto，自动。<br>我们可以通过 <code>hasTorch</code> 检查设备是否有闪光灯，可以通过 <code>isTorchModeSupported:</code> 检查设备是否支持对应的手电筒模式，通过 <code>torchMode</code> 设置对应的模式。</li>
</ul>
<h4 id="视频防抖"><a href="#视频防抖" class="headerlink" title="视频防抖"></a>视频防抖</h4><p>视频防抖主要依赖于硬件，虽然如此，也不是所有的视频格式和分辨率都能支持。此外，开启防抖也会带来为视频录制带来一定的延迟。我们可以通过 <code>videoStabilizationEnabled</code> 来检查是否启动了防抖，通过 <code>enablesVideoStabilizationWhenAvailable</code> 来允许应用在条件支持的情况下自动开启防抖。</p>
<h4 id="白平衡"><a href="#白平衡" class="headerlink" title="白平衡"></a>白平衡</h4><p>目前支持面几种白平衡模式：</p>
<ul>
<li>AVCaptureWhiteBalanceModeLocked，固定模式。</li>
<li>AVCaptureWhiteBalanceModeAutoWhiteBalance，自动模式。相机根据情况调整一次白平衡，然后切换至 AVCaptureWhiteBalanceModeLocked 模式。</li>
<li>AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance，相机随时根据情况调整白平衡。<br>我们可以通过 <code>isWhiteBalanceModeSupported:</code> 检查是否支持给定的模式，然后通过 <code>whiteBalanceMode</code> 设置对应模式。</li>
</ul>
<p>我们可以访问 <code>adjustingWhiteBalance</code> 属性来获知相机是否正在改变白平衡设置，这个属性是支持 KVO 的，所以我们可以监测它来获知白平衡状态的变化。</p>
<h4 id="设置方向"><a href="#设置方向" class="headerlink" title="设置方向"></a>设置方向</h4><p>我们可以通过 <code>AVCaptureConnection</code> 实例来设置想要在 AVCaptureOutput(AVCaptureMovieFileOutput, AVCaptureStillImageOutput, AVCaptureVideoDataOutput) 获得的图像方向。</p>
<p>我们通过 <code>isVideoOrientationSupported</code> 检查是否支持改变视频方向，通过 <code>videoOrientation</code> 设置方向。</p>
<p>下面是示例代码：</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureConnection <span class="token operator">*</span>captureConnection <span class="token operator">=</span> <span class="token operator">&lt;</span>#A capture connection#<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>captureConnection isVideoOrientationSupported<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AVCaptureVideoOrientation orientation <span class="token operator">=</span> AVCaptureVideoOrientationLandscapeLeft<span class="token punctuation">;</span>
    <span class="token punctuation">[</span>captureConnection setVideoOrientation<span class="token punctuation">:</span>orientation<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="配置设备"><a href="#配置设备" class="headerlink" title="配置设备"></a>配置设备</h4><p>在设置设备的相关属性前，我们需要使用 lockForConfiguration: 来获取一个对设备操作的锁，这样可以避免你在使用设备时被别的应用更改了设置而导致不兼容等问题。</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>device isFocusModeSupported<span class="token punctuation">:</span>AVCaptureFocusModeLocked<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    NSError <span class="token operator">*</span>error <span class="token operator">=</span> nil<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>device lockForConfiguration<span class="token punctuation">:</span><span class="token operator">&amp;</span>error<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        device<span class="token punctuation">.</span>focusMode <span class="token operator">=</span> AVCaptureFocusModeLocked<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>device unlockForConfiguration<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Respond to the failure as appropriate.</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>你应该只在希望设备的设置不能被修改时保持设备锁，不正确的持有设备锁可能会影响其他程序的录制质量。</p>
<h4 id="设备切换"><a href="#设备切换" class="headerlink" title="设备切换"></a>设备切换</h4><p>有时候你可能需要在使用时切换设备，比如切换前后摄像头。这时为了避免卡顿或者闪屏，我们可以重新配置一个正在执行的 <code>session</code>，但是我们在修改前后需要分别使用 <code>beginConfiguration</code> 和 <code>commitConfiguration:</code></p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token operator">&lt;</span>#A capture session#<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>session beginConfiguration<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>session removeInput<span class="token punctuation">:</span>frontFacingCameraDeviceInput<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>session addInput<span class="token punctuation">:</span>backFacingCameraDeviceInput<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>session commitConfiguration<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>当最外的 <code>commitConfiguration</code> 被调用时，所有的配置修改会被一起提交，这样可以保证平滑的切换。</p>
<h2 id="使用-Capture-Inputs-来给一个-Session-添加设备"><a href="#使用-Capture-Inputs-来给一个-Session-添加设备" class="headerlink" title="使用 Capture Inputs 来给一个 Session 添加设备"></a>使用 Capture Inputs 来给一个 Session 添加设备</h2><p>我们可以用 <code>AVCaptureDeviceInput</code> 来给一个 <code>session</code> 添加设备。<code>AVCaptureDeviceInput</code> 是用来管理设备的端口。</p>
<pre class=" language-objectivec"><code class="language-objectivec">NSError <span class="token operator">*</span>error<span class="token punctuation">;</span>
AVCaptureDeviceInput <span class="token operator">*</span>input <span class="token operator">=</span> <span class="token punctuation">[</span>AVCaptureDeviceInput deviceInputWithDevice<span class="token punctuation">:</span>device error<span class="token punctuation">:</span><span class="token operator">&amp;</span>error<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle the error appropriately.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们用 <code>addInput:</code> 来添加设备。我们还可以在添加前用 <code>canAddInput:</code> 来检查一下。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureSession <span class="token operator">*</span>captureSession <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a capture session#<span class="token operator">></span><span class="token punctuation">;</span>
AVCaptureDeviceInput <span class="token operator">*</span>captureDeviceInput <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a capture device input#<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>captureSession canAddInput<span class="token punctuation">:</span>captureDeviceInput<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>captureSession addInput<span class="token punctuation">:</span>captureDeviceInput<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle the failure.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>AVCaptureInput</code> 声明一个或者多个媒体数据流。例如，输入设备可以同时提供音频和视频数据。输入提供的每个媒体流都被一个 <code>AVCaptureInputPort</code> 所表示。一个会话使用 <code>AVCaptureConnection</code> 对象来定义一组 <code>AVCaptureInputPort</code> 对象和一个 <code>AVCaptureOutput</code> 之间的映射。</p>
<h2 id="使用-Capture-Outputs-来从一个-Session-获取输出"><a href="#使用-Capture-Outputs-来从一个-Session-获取输出" class="headerlink" title="使用 Capture Outputs 来从一个 Session 获取输出"></a>使用 Capture Outputs 来从一个 Session 获取输出</h2><p>要从一个 <code>capture session</code> 中获取输出，我们需要给它添加一个或多个输出实例，输出实例都是 <code>AVCaptureOutput</code> 的子类。比如：</p>
<ul>
<li>AVCaptureMovieFileOutput，输出电影文件。</li>
<li>AVCaptureVideoDataOutput，当我们需要处理录制得到的视频帧时（比如创建自定义的渲染层），可以用这个。</li>
<li>AVCaptureAudioDataOutput，当我们需要处理录制到的音频数据时，可以用这个。</li>
<li>AVCaptureStillImageOutput，当我们需要获取静态图片以及对应的 metadata 时，可以用这个。<br>我们可以使用 <code>addOutput:</code> 向 <code>session</code> 中添加输出实例，我们也可以在加之前，通过 <code>canAddOutput:</code> 来检测要添加的输出实例是否是兼容的。我们可以往一个正在运行状态的 <code>session</code> 中添加输出实例。</li>
</ul>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureSession <span class="token operator">*</span>captureSession <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a capture session#<span class="token operator">></span><span class="token punctuation">;</span>
AVCaptureMovieFileOutput <span class="token operator">*</span>movieOutput <span class="token operator">=</span> <span class="token operator">&lt;</span>#Create and configure a movie output#<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>captureSession canAddOutput<span class="token punctuation">:</span>movieOutput<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>captureSession addOutput<span class="token punctuation">:</span>movieOutput<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle the failure.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="保存电影文件"><a href="#保存电影文件" class="headerlink" title="保存电影文件"></a>保存电影文件</h2><p>使用 <code>AVCaptureMovieFileOutput</code> 将音视频数据保存到文件中时，我们可以做一些输出设置，比如最大录制时长、最大文件尺寸等等。我们还能够在硬盘空间不够时停止录制。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureMovieFileOutput <span class="token operator">*</span>aMovieFileOutput <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVCaptureMovieFileOutput alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
CMTime maxDuration <span class="token operator">=</span> <span class="token operator">&lt;</span>#Create a CMTime to represent the maximum duration#<span class="token operator">></span><span class="token punctuation">;</span>
aMovieFileOutput<span class="token punctuation">.</span>maxRecordedDuration <span class="token operator">=</span> maxDuration<span class="token punctuation">;</span>
aMovieFileOutput<span class="token punctuation">.</span>minFreeDiskSpaceLimit <span class="token operator">=</span> <span class="token operator">&lt;</span>#An appropriate minimum given the quality of the movie format and the duration#<span class="token operator">></span><span class="token punctuation">;</span>
</code></pre>
<p>录制时输出的分辨率和码率是根据 capture session 的 sessionPreset 属性而定的。其中视频的编码类型是 H.264，音频的编码类型是 AAC，这个也是由不同的设备类型决定的。</p>
<h4 id="开始录制"><a href="#开始录制" class="headerlink" title="开始录制"></a>开始录制</h4><p>我们通过 <code>startRecordingToOutputFileURL:recordingDelegate:</code> 来开始录制，这时你需要提供一个文件 <code>URL</code> 和一个 <code>delegate</code>。这个 <code>URL</code> 不能指向已存在的文件，因为这里的音视频输出不会去覆盖已有的资源。同时我们也必须要有对这个 <code>URL</code> 指向位置的写权限。这里的 <code>delegate</code> 必须遵循 <code>AVCaptureFileOutputRecordingDelegate</code> 协议，而且必须实现 <code>captureOutput:didFinishRecordingToOutputFileAtURL:fromConnections:error:</code> 方法。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureMovieFileOutput <span class="token operator">*</span>aMovieFileOutput <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a movie file output#<span class="token operator">></span><span class="token punctuation">;</span>
NSURL <span class="token operator">*</span>fileURL <span class="token operator">=</span> <span class="token operator">&lt;</span>#A file URL that identifies the output location#<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>aMovieFileOutput startRecordingToOutputFileURL<span class="token punctuation">:</span>fileURL recordingDelegate<span class="token punctuation">:</span><span class="token operator">&lt;</span>#The delegate#<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>在 <code>captureOutput:didFinishRecordingToOutputFileAtURL:fromConnections:error:</code> 方法中，<code>delegate</code> 可以将最终输出的文件写入相册，同时也需要检查和处理各种可能出现的错误。</p>
<h4 id="确保文件写入成功"><a href="#确保文件写入成功" class="headerlink" title="确保文件写入成功"></a>确保文件写入成功</h4><p>要确保文件是否成功，我们可以在 <code>captureOutput:didFinishRecordingToOutputFileAtURL:fromConnections:error:</code> 方法中检查 <code>AVErrorRecordingSuccessfullyFinishedKey</code>。</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>captureOutput<span class="token punctuation">:</span><span class="token punctuation">(</span>AVCaptureFileOutput <span class="token operator">*</span><span class="token punctuation">)</span>captureOutput didFinishRecordingToOutputFileAtURL<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURL <span class="token operator">*</span><span class="token punctuation">)</span>outputFileURL fromConnections<span class="token punctuation">:</span><span class="token punctuation">(</span>NSArray <span class="token operator">*</span><span class="token punctuation">)</span>connections error<span class="token punctuation">:</span><span class="token punctuation">(</span>NSError <span class="token operator">*</span><span class="token punctuation">)</span>error <span class="token punctuation">{</span>

    BOOL recordedSuccessfully <span class="token operator">=</span> YES<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>error code<span class="token punctuation">]</span> <span class="token operator">!=</span> noErr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A problem occurred: Find out if the recording was successful.</span>
        id value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>error userInfo<span class="token punctuation">]</span> objectForKey<span class="token punctuation">:</span>AVErrorRecordingSuccessfullyFinishedKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            recordedSuccessfully <span class="token operator">=</span> <span class="token punctuation">[</span>value boolValue<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Continue as appropriate...</span>
</code></pre>
<p>我们需要检查 <code>error</code> 的 <code>userInfo</code> 的 <code>AVErrorRecordingSuccessfullyFinishedKey</code> 对应的值，因为有时候即使我们收到了错误，文件也可能是保存成功的，这时候，有可能是触及了我们设置的某些限制，比如 <code>AVErrorMaximumDurationReached</code> 或者 <code>AVErrorMaximumFileSizeReached</code>，其他的原因还有：</p>
<ul>
<li>AVErrorDiskFull，磁盘空间不够。</li>
<li>AVErrorDeviceWasDisconnected，录制设备断开连接。</li>
<li>AVErrorSessionWasInterrupted，录制 <code>session</code> 被打断了，比如来电话了。</li>
</ul>
<h4 id="给文件添加-Metadata"><a href="#给文件添加-Metadata" class="headerlink" title="给文件添加 Metadata"></a>给文件添加 Metadata</h4><p>我们可以在任何时候给录制的文件设置 <code>metadata</code>，即使是在录制过程中。文件的 <code>metadata</code> 是由一系列的 <code>AVMetadataItem</code> 对象表示，我们可以用 <code>AVMutableMetadataItem</code> 来创建我们自己的 <code>metadata</code>。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureMovieFileOutput <span class="token operator">*</span>aMovieFileOutput <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a movie file output#<span class="token operator">></span><span class="token punctuation">;</span>
NSArray <span class="token operator">*</span>existingMetadataArray <span class="token operator">=</span> aMovieFileOutput<span class="token punctuation">.</span>metadata<span class="token punctuation">;</span>
NSMutableArray <span class="token operator">*</span>newMetadataArray <span class="token operator">=</span> nil<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>existingMetadataArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newMetadataArray <span class="token operator">=</span> <span class="token punctuation">[</span>existingMetadataArray mutableCopy<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    newMetadataArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSMutableArray alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

AVMutableMetadataItem <span class="token operator">*</span>item <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVMutableMetadataItem alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
item<span class="token punctuation">.</span>keySpace <span class="token operator">=</span> AVMetadataKeySpaceCommon<span class="token punctuation">;</span>
item<span class="token punctuation">.</span>key <span class="token operator">=</span> AVMetadataCommonKeyLocation<span class="token punctuation">;</span>

CLLocation <span class="token operator">*</span>location <span class="token operator">-</span> <span class="token operator">&lt;</span>#The location to set#<span class="token operator">></span><span class="token punctuation">;</span>
item<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%+08.4lf%+09.4lf/"</span> location<span class="token punctuation">.</span>coordinate<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span> location<span class="token punctuation">.</span>coordinate<span class="token punctuation">.</span>longitude<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>newMetadataArray addObject<span class="token punctuation">:</span>item<span class="token punctuation">]</span><span class="token punctuation">;</span>

aMovieFileOutput<span class="token punctuation">.</span>metadata <span class="token operator">=</span> newMetadataArray<span class="token punctuation">;</span>
</code></pre>
<h4 id="处理视频帧"><a href="#处理视频帧" class="headerlink" title="处理视频帧"></a>处理视频帧</h4><p><code>AVCaptureVideoDataOutput</code><br> 对象使用代理来对外暴露视频帧，我们通过 <code>setSampleBufferDelegate:queue:</code><br> 来设置代理。除了设置代理以外，还需要设置一个 <code>serial queue</code> 来供代理调用，这里必须使用 <code>serial queue</code> 来保证传给 <code>delegate</code> 的帧数据的顺序正确。我们可以使用这个 queue 来分发和处理视频帧，这里可以参考一下例子 <a href="https://developer.apple.com/library/content/samplecode/SquareCam/Introduction/Intro.html#//apple_ref/doc/uid/DTS40011190" target="_blank" rel="external">SquareCam</a>。<br><code>captureOutput:didOutputSampleBuffer:fromConnection:</code><br> 中输出的视频帧数据是用 <code>CMSampleBufferRef</code><br> 来表示的。默认情况下，这个 <code>buffer</code> 的数据格式来自于相机能最高效处理的格式。我们可以通过 <code>videoSettings</code><br> 来设置一个自定义的输出格式，这个值是一个字典，现在支持的键包括 <code>kCVPixelBufferPixelFormatTypeKey</code><br>。推荐的 <code>pixel formats</code> 可以通过 <code>availableVideoCVPixelFormatTypes</code><br> 属性获得，此外还能通过 <code>availableVideoCodecTypes</code><br> 获得支持编码类型。<code>Core Graphics</code> 和 <code>OpenGL</code> 都能很好地处理 <code>BGRA</code><br> 格式。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureVideoDataOutput <span class="token operator">*</span>videoDataOutput <span class="token operator">=</span> <span class="token punctuation">[</span>AVCaptureVideoDataOutput new<span class="token punctuation">]</span><span class="token punctuation">;</span>NSDictionary <span class="token operator">*</span>newSettings <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">{</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span> kCVPixelBufferPixelFormatTypeKey<span class="token punctuation">:</span> <span class="token operator">@</span><span class="token punctuation">(</span>kCVPixelFormatType_32BGRA<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>videoDataOutput<span class="token punctuation">.</span>videoSettings <span class="token operator">=</span> newSettings<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// discard if the data output queue is blocked (as we process the still image[videoDataOutput setAlwaysDiscardsLateVideoFrames:YES];)// create a serial dispatch queue used for the sample buffer delegate as well as when a still image is captured// a serial dispatch queue must be used to guarantee that video frames will be delivered in order// see the header doc for setSampleBufferDelegate:queue: for more informationvideoDataOutputQueue = dispatch_queue_create("VideoDataOutputQueue", DISPATCH_QUEUE_SERIAL);[videoDataOutput setSampleBufferDelegate:self queue:videoDataOutputQueue];AVCaptureSession *captureSession = &lt;#The Capture Session#>;if ([captureSession canAddOutput:videoDataOutput]) { [captureSession addOutput:videoDataOutput];}</span>
</code></pre>
<h4 id="处理视频的性能问题"><a href="#处理视频的性能问题" class="headerlink" title="处理视频的性能问题"></a>处理视频的性能问题</h4><p>对于我们的应用，设置够用的分辨率就好了，不要太高，那样性能会降低。</p>
<p>我们需要确保，在 <code>captureOutput:didOutputSampleBuffer:fromConnection:</code> 中处理视频帧的时间开销不要超过分配给一帧的处理时长。如果这里处理的太长，那么 <code>AV Foundation</code> 将会停止发送视频帧给代理，也会停止发给其他输出端，比如 <code>preview layer</code>。</p>
<p>你可以使用 <code>AVCaptureVideoDataOutput</code> 的 <code>minFrameDuration</code> 属性来确保你有足够的时间来处理一帧。同时，我们还可以设置 <code>alwaysDiscardsLateVideoFrames</code> 为 YES 来确保晚到的帧会被丢掉来避免延迟。如果你不介意延迟，而更想要处理更多的帧，那就设置这个值为 NO，但是这并不意味着不会丢帧，只是不会被那么早或那么高效的丢掉。</p>
<h2 id="截取静态图片"><a href="#截取静态图片" class="headerlink" title="截取静态图片"></a>截取静态图片</h2><p>当我们想要截取带着 <code>metadata</code> 的静态图片时，我们可以用 <code>AVCaptureStillImageOutput</code>。截出的图的分辨率依赖于 <code>session</code> 的 <code>preset</code> 和具体的设备。</p>
<h4 id="像素和编码类型"><a href="#像素和编码类型" class="headerlink" title="像素和编码类型"></a>像素和编码类型</h4><p>不同的类型支持不同的图片格式。我们可以用 <code>availableImageDataCVPixelFormatTypes</code> 和 <code>availableImageDataCodecTypes</code> 来检查当前的设备支持的像素类型和编码类型。然后，我们可以通过设置 <code>outputSettings</code> 属性指定图片的格式。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureStillImageOutput <span class="token operator">*</span>stillImageOutput <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVCaptureStillImageOutput alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
NSDictionary <span class="token operator">*</span>outputSettings <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">{</span>AVVideoCodecKey<span class="token punctuation">:</span> AVVideoCodecJPEG<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>stillImageOutput setOutputSettings<span class="token punctuation">:</span>outputSettings<span class="token punctuation">]</span><span class="token punctuation">;</span>
`
</code></pre>
<p>如果我们要截取一张 JPEG 图片，你最好不要指定你自己的压缩格式，相反，你需要做的是让 <code>AVCaptureStillImageOutput</code> 帮你做压缩，因为它使用硬件加速来压缩。如果这时你需要图像的数据，可以用 <code>jpegStillImageNSDataRepresentation:</code> 来获取对应的 <code>NSData</code> 对象，这个数据是未经压缩的，甚至你都可以修改它。</p>
<h4 id="捕获图像"><a href="#捕获图像" class="headerlink" title="捕获图像"></a>捕获图像</h4><p>当截图时，我们使用 <code>captureStillImageAsynchronouslyFromConnection:completionHandler:</code>方法，其中的第一个参数是对应的 <code>connection</code>，这是你需要查找一下哪个 <code>connection</code> 的输出端口是在手机视频：</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureConnection <span class="token operator">*</span>videoConnection <span class="token operator">=</span> nil<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>AVCaptureConnection <span class="token operator">*</span>connection <span class="token keyword">in</span> stillImageOutput<span class="token punctuation">.</span>connections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>AVCaptureInputPort <span class="token operator">*</span>port <span class="token keyword">in</span> <span class="token punctuation">[</span>connection inputPorts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>port mediaType<span class="token punctuation">]</span> isEqual<span class="token punctuation">:</span>AVMediaTypeVideo<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            videoConnection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>第二个参数是一个 <code>block</code> 回调，其中带回两个参数：一个包含图像数据的 <code>CMSampleBuffer</code>，一个 <code>NSError</code>。这个 <code>sample buffer</code> 中可能包含着 <code>metadata</code>，比如一个 EXIF 字典作为附属信息。我们可以去修改附属信息，但是需要注意针对 JPEG 图像的像素和编码上的优化。</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>stillImageOutput captureStillImageAsynchronouslyFromConnection<span class="token punctuation">:</span>videoConnection completionHandler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>CMSampleBufferRef imageSampleBuffer<span class="token punctuation">,</span> NSError <span class="token operator">*</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CFDictionaryRef exifAttachments <span class="token operator">=</span>
        <span class="token function">CMGetAttachment</span><span class="token punctuation">(</span>imageSampleBuffer<span class="token punctuation">,</span> kCGImagePropertyExifDictionary<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exifAttachments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Do something with the attachments.</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Continue as appropriate.</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h2><h4 id="视频预览"><a href="#视频预览" class="headerlink" title="视频预览"></a>视频预览</h4><p>我们可以用 <code>AVCaptureVideoPreviewLayer</code> 来给用户提供预览，我们不需要任何 <code>output</code> 对象来展示预览。此外，我们可以使用 <code>AVCaptureVideoDataOutput</code> 来在给用户预览之前获取到图像像素级别的数据。</p>
<p>Unlike a capture output, a video preview layer maintains a strong reference to the session with which it is associated. This is to ensure that the session is not deallocated while the layer is attempting to display video. This is reflected in the way you initialize a preview layer:</p>
<p>不像 <code>capture output</code>，一个 <code>video preview layer</code> 会持有一个关联 <code>session</code> 的强引用。这样来防止 <code>layer</code> 在展示预览时而 <code>session</code> 被释放引起问题。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureSession <span class="token operator">*</span>captureSession <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a capture session#<span class="token operator">></span><span class="token punctuation">;</span>
CALayer <span class="token operator">*</span>viewLayer <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get a layer from the view <span class="token keyword">in</span> which you want to present the preview#<span class="token operator">></span><span class="token punctuation">;</span>

AVCaptureVideoPreviewLayer <span class="token operator">*</span>captureVideoPreviewLayer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVCaptureVideoPreviewLayer alloc<span class="token punctuation">]</span> initWithSession<span class="token punctuation">:</span>captureSession<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>viewLayer addSublayer<span class="token punctuation">:</span>captureVideoPreviewLayer<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>一般来说，<code>preview layer</code> 和其他 <code>CALayer</code> 对象一样，我们可以缩放它的图像，执行变换，旋转。一个不同的地方是，我们需要设置 <code>layer</code> 的 <code>orientation</code> 属性来指定它改如何旋转从相机获得的图像。此外，我们可以用 <code>supportsVideoMirroring</code> 来测试设备是否支持视频镜面效果(左右翻转)，我们可以设置 <code>videoMirrored</code> 来配置是否开启镜面效果，即使 <code>automaticallyAdjustsVideoMirroring</code> 被设置为默认的 YES 也没问题(这个值是在配置 <code>session</code> 时被自动设置的)。</p>
<h4 id="视频重力模式"><a href="#视频重力模式" class="headerlink" title="视频重力模式"></a>视频重力模式</h4><p>我们可以通过 <code>videoGravity</code><br> 属性设置视频重力模式，比如：</p>
<ul>
<li>AVLayerVideoGravityResizeAspect<br>，保持视频的宽高比；不一定完全填充，可能留黑边；不裁剪视频，。</li>
<li>AVLayerVideoGravityResizeAspectFill<br>，保持视频的宽高比；完全填充，不留黑边；可能裁剪视频。</li>
<li>AVLayerVideoGravityResize<br>，不保持视频宽高比，可能扭曲画面；完全填充；不裁剪视频。</li>
</ul>
<h4 id="使用预览时的点击聚焦"><a href="#使用预览时的点击聚焦" class="headerlink" title="使用预览时的点击聚焦"></a>使用预览时的点击聚焦</h4><p>需要注意的是，在实现点击聚焦时必须考虑到该层的预览方向和重力，并考虑预览变为镜像显示的可能性。可以参考实例项目：<a href="https://developer.apple.com/library/content/samplecode/AVCam/Introduction/Intro.html#//apple_ref/doc/uid/DTS40010112" target="_blank" rel="external">AVCam-iOS: Using AVFoundation to Capture Images and Movies</a>。</p>
<h2 id="显示音频等级"><a href="#显示音频等级" class="headerlink" title="显示音频等级"></a>显示音频等级</h2><p>To monitor the average and peak power levels in an audio channel in a capture connection, you use an AVCaptureAudioChannel object. Audio levels are not key-value observable, so you must poll for updated levels as often as you want to update your user interface (for example, 10 times a second).</p>
<p>要监测 capture connection 中音频通道的平均强度和峰值强度，我们可以用 <code>AVCaptureAudioChannel</code>。音频等级是不支持 KVO 监测的，所以当我们想更新用户界面时，我们需要去查询。</p>
<pre class=" language-objectivec"><code class="language-objectivec">AVCaptureAudioDataOutput <span class="token operator">*</span>audioDataOutput <span class="token operator">=</span> <span class="token operator">&lt;</span>#Get the audio data output#<span class="token operator">></span><span class="token punctuation">;</span>
NSArray <span class="token operator">*</span>connections <span class="token operator">=</span> audioDataOutput<span class="token punctuation">.</span>connections<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>connections count<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// There should be only one connection to an AVCaptureAudioDataOutput.</span>
    AVCaptureConnection <span class="token operator">*</span>connection <span class="token operator">=</span> <span class="token punctuation">[</span>connections objectAtIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    NSArray <span class="token operator">*</span>audioChannels <span class="token operator">=</span> connection<span class="token punctuation">.</span>audioChannels<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>AVCaptureAudioChannel <span class="token operator">*</span>channel <span class="token keyword">in</span> audioChannels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">float</span> avg <span class="token operator">=</span> channel<span class="token punctuation">.</span>averagePowerLevel<span class="token punctuation">;</span>
        <span class="token keyword">float</span> peak <span class="token operator">=</span> channel<span class="token punctuation">.</span>peakHoldLevel<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Update the level meter user interface.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="一个完整示例"><a href="#一个完整示例" class="headerlink" title="一个完整示例"></a>一个完整示例</h2><p>这里的示例代码将展示如何获取视频并转化为 UIImage。大概包括下面几步：</p>
<ul>
<li>创建一个 AVCaptureSession 对象来协调输入设备到输出的数据流。</li>
<li>找到我们想要的 AVCaptureDevice。</li>
<li>为 device 创建一个 AVCaptureDeviceInput 对象。</li>
<li>创建 AVCaptureVideoDataOutput 来输出视频帧。</li>
<li>实现 AVCaptureVideoDataOutput 的 delegate 方法来处理视频帧。</li>
<li>在实现的代理方法中将 CMSampleBuffer 转为 UIImage。<br>代码如下：</li>
</ul>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token comment" spellcheck="true">// 创建并配置 Capture Session：</span>
AVCaptureSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVCaptureSession alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span>sessionPreset <span class="token operator">=</span> AVCaptureSessionPresetMedium<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 创建和配置 Device 和 Device Input：</span>
AVCaptureDevice <span class="token operator">*</span>device <span class="token operator">=</span> <span class="token punctuation">[</span>AVCaptureDevice defaultDeviceWithMediaType<span class="token punctuation">:</span>AVMediaTypeVideo<span class="token punctuation">]</span><span class="token punctuation">;</span>

NSError <span class="token operator">*</span>error <span class="token operator">=</span> nil<span class="token punctuation">;</span>
AVCaptureDeviceInput <span class="token operator">*</span>input <span class="token operator">=</span> <span class="token punctuation">[</span>AVCaptureDeviceInput deviceInputWithDevice<span class="token punctuation">:</span>device error<span class="token punctuation">:</span><span class="token operator">&amp;</span>error<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle the error appropriately.</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>session addInput<span class="token punctuation">:</span>input<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 创建和配置 Video Data Output：</span>
AVCaptureVideoDataOutput <span class="token operator">*</span>output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVCaptureVideoDataOutput alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>session addOutput<span class="token punctuation">:</span>output<span class="token punctuation">]</span><span class="token punctuation">;</span>
output<span class="token punctuation">.</span>videoSettings <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">{</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span> kCVPixelBufferPixelFormatTypeKey<span class="token punctuation">:</span> <span class="token operator">@</span><span class="token punctuation">(</span>kCVPixelFormatType_32BGRA<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
output<span class="token punctuation">.</span>minFrameDuration <span class="token operator">=</span> <span class="token function">CMTimeMake</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 设置 Video Data Output 的 delegate 和处理队列：</span>
dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">"MyQueue"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>output setSampleBufferDelegate<span class="token punctuation">:</span><span class="token keyword">self</span> queue<span class="token punctuation">:</span>queue<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>代理方法实现：</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>captureOutput<span class="token punctuation">:</span><span class="token punctuation">(</span>AVCaptureOutput <span class="token operator">*</span><span class="token punctuation">)</span>captureOutput didOutputSampleBuffer<span class="token punctuation">:</span><span class="token punctuation">(</span>CMSampleBufferRef<span class="token punctuation">)</span>sampleBuffer fromConnection<span class="token punctuation">:</span><span class="token punctuation">(</span>AVCaptureConnection <span class="token operator">*</span><span class="token punctuation">)</span>connection <span class="token punctuation">{</span>

    UIImage <span class="token operator">*</span>image <span class="token operator">=</span> <span class="token function">imageFromSampleBuffer</span><span class="token punctuation">(</span>sampleBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Add your code here that uses the image.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>开始录制：</p>
<p>录制前，还需要注意申请相机权限：</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token comment" spellcheck="true">// 申请权限：</span>
NSString <span class="token operator">*</span>mediaType <span class="token operator">=</span> AVMediaTypeVideo<span class="token punctuation">;</span>

<span class="token punctuation">[</span>AVCaptureDevice requestAccessForMediaType<span class="token punctuation">:</span>mediaType completionHandler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>BOOL granted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>granted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//Granted access to mediaType</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span> setDeviceAuthorized<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//Not granted access to mediaType</span>
        <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>UIAlertView alloc<span class="token punctuation">]</span> initWithTitle<span class="token punctuation">:</span><span class="token string">@"AVCam!"</span>
                                    message<span class="token punctuation">:</span><span class="token string">@"AVCam doesn't have permission to use Camera, please change privacy settings"</span>
                                   delegate<span class="token punctuation">:</span><span class="token keyword">self</span>
                          cancelButtonTitle<span class="token punctuation">:</span><span class="token string">@"OK"</span>
                          otherButtonTitles<span class="token punctuation">:</span>nil<span class="token punctuation">]</span> show<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span> setDeviceAuthorized<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>开始录制方法：</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>session startRunning<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>停止录制方法：</p>
<pre class=" language-objectivec"><code class="language-objectivec"><span class="token punctuation">[</span>session stopRunning<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="高帧率视频获取"><a href="#高帧率视频获取" class="headerlink" title="高帧率视频获取"></a>高帧率视频获取</h4><p>iOS 7 以后在一些设备中引入了高帧率视频捕获的支持。我们可以通过 <code>AVCaptureDeviceFormat</code> 来查询设备支持的媒体类型、帧率、缩放比、视频防抖等。在 AVFoundation 中：</p>
<ul>
<li>支持捕获分辨率 720p 及以上、帧率 60 fps、视频防抖、P 帧丢帧。</li>
<li>播放方面增强了对音频加速和慢速播放的支持。</li>
<li>编辑方面提供了全面的编辑能力支持。</li>
<li>输出方面支持两种方式输出帧率达 60 fps 的影视文件。一种是输出为可变帧率，支持慢速或快速播放。另一种是输出为任意指定帧率，比如 30 fps。<br>需要注意的是，现在最新的 iOS 版本支持的能力会比以上这些更多更强大。</li>
</ul>
<h4 id="播放"><a href="#播放" class="headerlink" title="播放"></a>播放</h4><p>播放时，可以通过 <code>AVPlayer</code> 设置 <code>rate</code> 属性来设置播放速率。</p>
<p><code>AVPlayerItem</code> 可以支持通过 <code>audioTimePitchAlgorithm</code> 属性来设置当你用不同的速率播放视频时，该如何播放音频。以下是相关选项：</p>
<ul>
<li>AVAudioTimePitchAlgorithmLowQualityZeroLatency，较低音质，适应多种播放速率。适宜的速率：0.5, 0.666667, 0.8, 1.0, 1.25, 1.5, 2.0.</li>
<li>AVAudioTimePitchAlgorithmTimeDomain，普通音质。适宜的速率：0.5–2x。</li>
<li>AVAudioTimePitchAlgorithmSpectral，最高音质，性能消耗较大。适宜的速率：1/32–32。</li>
<li>AVAudioTimePitchAlgorithmVarispeed，高音质。适宜的速率：1/32–32。</li>
</ul>
<h4 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h4><p>通常使用 <code>AVMutableComposition</code> 来做音视频编辑：</p>
<p>使用 <code>composition</code> 类方法类创建 <code>AVMutableComposition</code> 对象。<br>使用 <code>insertTimeRange:ofAsset:atTime:error:</code> 来插入音视频数据。<br>使用 <code>scaleTimeRange:toDuration:</code> 来设置音视频数据的时间区间。<br>导出</p>
<p>可以使用 <code>AVAssetExportSession</code> 来导出 60 fps 的视频，可以用以下两种方式：</p>
<p>使用 <code>AVAssetExportPresetPassthrough preset</code> 来编码重新编码视频。它会重新处理那些标记为 60 fps、降速、加速区域的时间。<br>使用一个固定帧率来保证导出视频的最大兼容性。比如设置 <code>video composition</code> 的 <code>frameDuration</code> 为 30 fps。比如设置 <code>export session</code> 的 <code>audioTimePitchAlgorithm</code> 来配置音频播放选项。<br>录制</p>
<p>我们用 <code>AVCaptureMovieFileOutput</code> 来录制高帧率的视频，它会默认支持高帧率的视频录制，会默认选择正确的 H264 pitch level 和比特率。</p>
<p>如果想要做一些自定义录制，我们必须使用 <code>AVAssetWriter</code>，这个则需要一些额外的创建过程。</p>
<p>通常我们需要设置一下：</p>
<pre class=" language-objectivec"><code class="language-objectivec">etWriterInput<span class="token punctuation">.</span>expectsMediaDataInRealTime <span class="token operator">=</span> YES<span class="token punctuation">;</span>
</code></pre>
<p>来保证视频捕获能跟得上传入的数据。</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/07/05/AVAudioFoundation-5-：音视频导出/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/07/03/AVAudioFoundation-3-：音视频编辑/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Aben's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        benkong_ah@foxmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: benkong_ah@foxmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">22</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">4</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/CSS笔记/">CSS笔记<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/categories/HTML笔记/">HTML笔记<span class="sidebar_archives-count">23</span></a></li><li><a class="sidebar_archives-link" href="/categories/iOS合集/">iOS合集<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/categories/小经验/">小经验<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/categories/技术向/">技术向<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/知识簿/">知识簿<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/自言语/">自言语<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/面试经/">面试经<span class="sidebar_archives-count">2</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="关于我">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于我
            </a>
        </li>
        
    
        <li>
            <a href="/gallery" title="剪影">
                
                    <i class="material-icons sidebar-material-icons">camera</i>
                
                剪影
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Aben
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#FFFAFA'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FFFAFA, 0 0 15px #FFFAFA'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FFFAFA',
        'border-left-color': '#FFFAFA'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setTimeout(function(){
            setInterval(function(){
                queue.execNext();
            },200);
        },3000);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
